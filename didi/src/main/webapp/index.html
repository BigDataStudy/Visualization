<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<script src="./js/echarts-all.js"></script>
		<script src="./js/jquery-3.0.0.js"></script>
	</head>
	
	<body>
		<div>
			<select id="district">
				<option value="fc34648599753c9e74ab238e9a4a07ad">朝阳<option>
				<option value="fff4e8465d1e12621bc361276b6217cf">海淀<option>
				<option value="f9280c5dab6910ed44e518248048b9fe">昌平<option>
			</select>
			
		</div>
		<button id="last-week">上一周</button><button id="next-week">下一周</button>
	    <table id="monitor">
	        <tr>
	            <td></td>
	            <td></td>
	            <td></td>
	            <td></td>
	            <td></td>
	            <td></td>
	            <td></td>
	        </tr>
	    </table>
		<div id="main" style="width:600p;height:400px;"></div>
		<script type="text/javascript">
			var myChart = echarts.init(document.getElementById("main"));
/* 			myChart.showLoading({  
		        text: 'Loading...'  
		    }); */
			var id = [];
			var reply = [];
			var request = [];
			var dateList = [];
			var dList = [];
			
			function getServerData(){
			   id = [];
			   reply = [];
			   request = [];
			   dList = [];
				$.ajax({
					type:'post',
					async:false,
					url:"/didi/RequestServlet",
					data:{district: $('#district').val(),datett:$('#datett').val()},
					dataType:'json',
					success:function(result){
					console.log(result);
					console.log(result.length);
						if(result){
							for(var i=0;i<result.length;i++){
							dList.push(result[i].date);
								for(var j=0; j<result[i].data.length;j++){
									id.push(result[i].data[j].id);
									reply.push(result[i].data[j].reply);
									request.push(result[i].data[j].request);
								}
							}
						}
					},
					error : function(errorMsg){
						alert("Sorry,loading fail!");
						myChart.hideLoading();
					}
				});
			}
			
			////////////////////////////////////////////////////////////////////////////
			//window.onload = function(){         
            var cells = $('td');
            var curDate =new Date();
            
            var formatDate = function(date){             
                var year = date.getFullYear()+'-';
                var month = (date.getMonth()+1)+'-';
                var day = date.getDate();
                var week = '('+['日','一','二','三','四','五','六'][date.getDay()]+')';  
				return year+month+day+' '+week;
            };
            var addDate= function(date,n){       
                date.setDate(date.getDate()+n);        
                return date;
            };
            var setDate = function(date){             
                addDate(curDate,-7);
				dateList = [];
                for(var i = 0;i<7;i++){                 
                    dateList[i] = formatDate(addDate(curDate,1));
                    cells[i].innerHTML = dateList[i];
                }
            };           
            
            setDate(new Date());
             
           	$('#last-week').click(function(){
                setDate(addDate(curDate,-7));
                console.log(dateList);
                getServerData();
                refresh();
            });             
            $('#next-week').click(function(){                 
                setDate(addDate(curDate,7));
                getServerData()
                 console.log(dateList);
                refresh();
            });     
        //  } 
		////////////////////////////////////////////////////////////////////////////	
			function getOption(){
				var option = {
						timeline:{
						// TODO the date should be from the response
							data:dateList,
							/* label:{
								formatter:function(s){
									return s.slice(0,10);
								}
							} */
							autoPlay:true,
							playInterval:10000
						},
						options:[{
							title : {
								text : '滴滴订单状态',
								subtext : '请求订单与响应订单'
							},
							tooltip : {
								trigger : 'axis'
							},
							legend : {
								data : [ '请求订单数量', '响应订单数量' ],
								selected:{
									'请求订单数量':true,
									'响应订单数量':true
								}
							},
							toolbox : {
								show : true,
								feature : {
									mark : {
										show : true
									},
									dataView : {
										show : true,
										readOnly : false
									},
									magicType : {
										show : true,
										type : [ 'line', 'bar' ]
									},
									restore : {
										show : true
									},
									saveAsImage : {
										show : true
									}
								}
							},
							calculable : true,
							xAxis : [ {
								type : 'category',
								axisLabel:{'interval':0},
								data : id
							} ],
							yAxis : [ {
								type : 'value',
								name:'单',
							    axisLabel:{formatter:'{value}'}
							} ],
							series : [ {
								name : '请求订单数量',
								type : 'bar',
								itemStyle : {
									normal : {
										color : 'rgba(193,35,43,0.5)',
										label : {
											show : true
										}
									}
								},
								data : request
							}, {
								name : '响应订单数量',
								type : 'bar',
								itemStyle : {
									normal : {
										color : 'rgba(181,195,52,1)',
										label : {
											show : true,
											textStyle : {
												color : '#27727B'
											}
										}
									}
								},
								data : reply
							}]
						},
						{
							title:{text : '某某地区滴滴订单状态'},
							series:[
								{},
								{},
							]
						}
					   ]
					};
				    return option;
			}
			
			$('#district').change(function(){
				console.log("distict changed");
				getServerData();
				refresh();
			});
			$('#datett').change(function(){
				console.log("date changed");
				getServerData();
				refresh();
			});
			
			refresh();
			function refresh(){
				//if (myChart && myChart.dispose)
					//myChart.dispose(); 
				myChart = echarts.init(document.getElementById("main"));
				getServerData();		
				//myChart.hideLoading();
				myChart.setOption(getOption() );
				//setTimeout("refresh()" , 10000);
			} 
			


//////////////////////////////////////////////////////////////////////////
			
			
		</script>
	</body>
</html>